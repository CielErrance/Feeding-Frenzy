# FishGame.cpp 架构与函数功能索引

本文件 (`src/FishGame/FishGame.cpp`) 是游戏的主要源代码文件，包含了程序入口、消息处理、游戏循环、逻辑更新和渲染等核心功能。

## 1. 程序入口与框架

| 行数范围 | 函数名 | 功能描述 |
| :--- | :--- | :--- |
| 59-93 | `wWinMain` | **程序入口点**。负责初始化全局字符串、注册窗口类、调用 `InitInstance` 创建窗口，并运行主消息循环。 |
| 100-117 | `MyRegisterClass` | **注册窗口类**。设置窗口样式、图标、光标、背景刷和消息处理函数 (`WndProc`)。 |
| 126-150 | `InitInstance` | **初始化实例**。创建并显示主程序窗口。设置了固定的窗口大小（不可调整）。 |
| 156-200 | `WndProc` | **窗口过程函数**。处理主要的 Windows 消息：<br>- `WM_CREATE`: 调用 `InitGame` 初始化游戏。<br>- `WM_KEYDOWN`/`UP`: 处理键盘输入。<br>- `WM_MOUSEMOVE`/`LBUTTON`: 处理鼠标输入。<br>- `WM_TIMER`: 游戏主循环触发器，调用 `TimerUpdate`。<br>- `WM_PAINT`: 调用 `Paint` 进行渲染。<br>- `WM_DESTROY`: 退出程序。 |

## 2. 初始化与输入处理

| 行数范围 | 函数名 | 功能描述 |
| :--- | :--- | :--- |
| 208-237 | `InitGame` | **游戏初始化**。加载位图资源、创建开始按钮、初始化背景图、设置初始场景 (`STAGE_STARTMENU`) 并启动游戏定时器。 |
| 239-254 | `KeyDown` | **键盘按下处理**。更新方向键的状态标志 (`keyUpDown` 等)。 |
| 256-276 | `KeyUp` | **键盘松开处理**。重置方向键的状态标志。 |
| 278-283 | `MouseMove` | **鼠标移动处理**。使用 `GET_X_LPARAM` 更新全局鼠标坐标 `mouseX`, `mouseY`。 |
| 285-321 | `LButtonDown` | **鼠标左键按下处理**。更新鼠标状态和坐标，并进行按钮点击检测（如点击“开始游戏”切换到 `STAGE_1`）。 |
| 323-329 | `LButtonUp` | **鼠标左键松开处理**。重置鼠标按下状态。 |

## 3. 游戏逻辑核心

| 行数范围 | 函数名 | 功能描述 |
| :--- | :--- | :--- |
| 331-375 | `TimerUpdate` | **定时器更新**（主循环）。<br>- 调用 `UpdateUnits` 更新所有单位状态。<br>- **新增功能**：在 `STAGE_1` 中随机生成横向游动的小鱼（从屏幕左右两侧生成）。<br>- 调用 `InvalidateRect` 触发重绘。 |
| 475-538 | `UpdateUnits` | **单位状态更新**。<br>- 遍历所有单位，根据类型调用对应的行为函数 (`UnitBehaviour_1`, `UnitBehaviour_SwimAcross`)。<br>- **清理逻辑**：移除生命值 `<=0` 的单位。<br>- **吃鱼逻辑**：检测玩家与敌对鱼的碰撞，若距离足够近则“吃掉”（玩家变大，增加进度，敌对鱼死亡）。 |
| 438-472 | `InitStage` | **场景初始化**。<br>- 根据 `stageID` 切换场景（开始菜单或游戏关卡）。<br>- 初始化背景、倒计时。<br>- 控制按钮可见性。<br>- **STAGE_1**：创建玩家单位 (`CreateUnit`)，并移除旧的随机小鱼生成代码（现由 `TimerUpdate` 动态生成）。 |

## 4. 单位行为逻辑

| 行数范围 | 函数名 | 功能描述 |
| :--- | :--- | :--- |
| 384-396 | `CreateButton` | **创建按钮**。分配 `Button` 结构体并初始化属性。 |
| 398-432 | `CreateUnit` | **创建单位**。分配 `Unit` 结构体，初始化阵营、类型、位置、帧动画序列，以及新增的波浪运动参数 (`wave_timer`, `initial_y`)。 |
| 540-593 | `UnitBehaviour_2` | **AI 行为 2**（随机游走）。<br>- *注意：目前代码中保留了此函数，但在 UpdateUnits 中 UNIT_FISH_TYPE2 已改用 UnitBehaviour_SwimAcross，此函数可能暂时未被使用或作为备用。*<br>- 实现简单的随机移动和边界反弹。 |
| 595-614 | `UnitBehaviour_SwimAcross` | **横向游动行为**（用于敌对小鱼）。<br>- 实现水平直线移动。<br>- 叠加正弦波垂直浮动效果。<br>- 越出屏幕边界后标记死亡 (`health=0`)。 |
| 616-728 | `UnitBehaviour_1` | **玩家/主角行为**。<br>- **鼠标跟随**：计算朝向鼠标的速度，带平滑加速。<br>- **停止半径**：接近鼠标时减速并停止转向，防止震荡。<br>- **索敌**：寻找最近的敌对鱼。<br>- **攻击逻辑**：当距离最近敌人足够近时，自动进入攻击状态。<br>- **移动控制**：在攻击状态下允许鼠标引导移动（防漂移）。<br>- **速度成长**：最大速度随体型增大而增加。 |

## 5. 渲染系统

| 行数范围 | 函数名 | 功能描述 |
| :--- | :--- | :--- |
| 734-809 | `Paint` | **绘图函数**。使用双缓冲技术渲染画面：<br>1. 绘制背景。<br>2. 绘制所有单位（`TransparentBlt` 处理透明）。<br>3. 绘制按钮。<br>4. 绘制进度条（仅在 `STAGE_1`）。<br>5. 将缓冲区复制到屏幕。 |
| 814-841 | `InitBackGround` | **背景初始化**。将原始背景位图拉伸 (`StretchBlt`) 到窗口大小，用于后续快速绘制。 |
